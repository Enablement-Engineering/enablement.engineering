---
import ThemeToggle from './ThemeToggle.astro';
import TableOfContents from './TableOfContents.astro';

const navItems = [
  { href: "/services", label: "Services", dotColor: "bg-primary" },
  { href: "/approach", label: "Approach & Patterns", dotColor: "bg-accent" },
  { href: "/case-studies", label: "Case Studies", dotColor: "bg-secondary" },
  { href: "/speaking", label: "Speaking", dotColor: "bg-primary" },
  { href: "/writing", label: "Writing", dotColor: "bg-accent" },
  { href: "/about", label: "About", dotColor: "bg-secondary" },
  { href: "/contact", label: "Contact", dotColor: "bg-primary" },
];
---

<a 
  href="#main" 
  class="sr-only focus:not-sr-only fixed top-4 left-4 bg-accent px-4 py-2 rounded-md z-50 focus-ring no-underline-link"
>
  Skip to content
</a>

<div id="header-wrapper" class="sticky top-0 z-40 bg-surface dark:bg-dark-surface transition-all duration-200">
  <header class="border-b border-accent-yellow dark:border-accent-yellow">
    <div id="header-content" class="max-w-4xl mx-auto px-6 md:px-8 py-md transition-all duration-200">
      <div class="flex justify-between items-center">
        <a 
          href="/" 
          id="logo-text"
          class="text-h3 font-medium hover:text-primary transition-all duration-200 no-underline-link"
        >
          dylan isaac
        </a>
        
        <!-- Desktop/Tablet Navigation -->
        <nav class="hidden md:flex items-center gap-6 mr-8">
          {navItems.map((item, index) => (
            <>
              <a 
                href={item.href} 
                class="hover:text-primary transition-colors no-underline-link"
              >
                {item.label}
              </a>
              {index < navItems.length - 1 && (
                <span 
                  class={`w-1.5 h-1.5 rounded-full ${item.dotColor}`} 
                  aria-hidden="true"
                ></span>
              )}
            </>
          ))}
        </nav>

        <div class="flex items-center gap-4">
          <ThemeToggle />
          <button 
            id="menu-toggle"
            aria-label="Toggle table of contents"
            aria-expanded="false"
            aria-controls="toc-sidebar"
            class="flex flex-col gap-1.5 p-2 hover:bg-surface-secondary dark:hover:bg-dark-surface-secondary rounded-lg transition-colors"
          >
            <span class="w-5 h-0.5 bg-primary"></span>
            <span class="w-5 h-0.5 bg-secondary"></span>
            <span class="w-5 h-0.5 bg-accent"></span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Table of Contents Sidebar -->
  <div 
    id="toc-sidebar"
    role="complementary"
    aria-labelledby="toc-heading"
    class="fixed right-0 top-[89px] bottom-0 w-64 bg-surface dark:bg-dark-surface transform translate-x-full overflow-y-auto transition-all duration-200"
  >
    <div class="p-6">
      <!-- Mobile-only Navigation -->
      <nav class="md:hidden space-y-8 mb-8" aria-label="Main">
        <ul class="space-y-4">
          {navItems.map((item) => (
            <li>
              <a 
                href={item.href} 
                class="block hover:text-accent transition-colors no-underline-link"
              >
                {item.label}
              </a>
            </li>
          ))}
        </ul>
      </nav>

      <!-- Table of Contents -->
      <nav aria-labelledby="toc-heading">
        <TableOfContents />
      </nav>
    </div>
  </div>
</div>

<script>
  const menuToggle = document.getElementById('menu-toggle');
  const tocSidebar = document.getElementById('toc-sidebar');
  const headerContent = document.getElementById('header-content');
  const logoText = document.getElementById('logo-text');
  
  // Function to check if there's enough room for the menu AND content
  const hasEnoughRoom = () => window.innerWidth >= 1216;
  
  // Handle header shrinking on scroll
  const handleScroll = () => {
    const scrollY = window.scrollY;
    const isScrolled = scrollY > 50;
    const headerWrapper = document.getElementById('header-wrapper');
    const header = headerWrapper?.querySelector('header');
    
    // Toggle a single class on document body for cleaner CSS control
    if (isScrolled) {
      document.body.classList.add('header-scrolled');
      // Set explicit height on header
      if (header) {
        header.style.height = '48px'; // Much smaller fixed height
        header.style.transition = 'all 200ms ease';
      }
      headerContent?.classList.remove('py-md');
      headerContent?.classList.add('py-1');
      if (headerContent) {
        headerContent.style.height = '48px';
      }
      logoText?.classList.remove('text-h3');
      logoText?.classList.add('text-base'); // Smaller text
      if (tocSidebar) {
        tocSidebar.style.top = '48px'; // Match header height
      }
      headerWrapper?.classList.add('shadow-md');
    } else {
      document.body.classList.remove('header-scrolled');
      // Remove height restriction
      if (header) {
        header.style.height = 'auto';
      }
      headerContent?.classList.remove('py-1');
      headerContent?.classList.add('py-md');
      if (headerContent) {
        headerContent.style.height = 'auto';
      }
      logoText?.classList.remove('text-base');
      logoText?.classList.add('text-h3');
      if (tocSidebar) {
        tocSidebar.style.top = '89px';
      }
      headerWrapper?.classList.remove('shadow-md');
    }
  };
  
  // Initial check on load
  handleScroll();
  
  // Add scroll listener with throttling
  let scrollTimeout: number;
  window.addEventListener('scroll', () => {
    if (scrollTimeout) {
      window.cancelAnimationFrame(scrollTimeout);
    }
    scrollTimeout = window.requestAnimationFrame(() => {
      handleScroll();
    });
  }, { passive: true });
  
  // Storage key for sidebar state
  const SIDEBAR_STATE_KEY = 'tocSidebarExpanded';
  
  // Check if we're on desktop (only save/load state on desktop)
  const isDesktop = () => window.innerWidth >= 1024; // md breakpoint and up
  
  // Get saved state from localStorage (only on desktop)
  const getSavedState = () => {
    // Don't use saved state on mobile/tablet
    if (!isDesktop()) {
      return false; // Always collapsed on mobile/tablet
    }
    
    const saved = localStorage.getItem(SIDEBAR_STATE_KEY);
    if (saved !== null) {
      return saved === 'true';
    }
    // Default to expanded if there's enough room
    return hasEnoughRoom();
  };
  
  // Save state to localStorage (only on desktop)
  const saveState = (isExpanded: boolean) => {
    // Only save state on desktop
    if (isDesktop()) {
      localStorage.setItem(SIDEBAR_STATE_KEY, isExpanded.toString());
    }
  };
  
  // Apply state to UI
  const applyState = (isExpanded: boolean, skipAnimation = false) => {
    menuToggle?.setAttribute('aria-expanded', isExpanded.toString());
    
    if (skipAnimation) {
      tocSidebar?.classList.toggle('translate-x-full', !isExpanded);
    } else {
      // Use setTimeout to ensure transition happens
      requestAnimationFrame(() => {
        tocSidebar?.classList.toggle('translate-x-full', !isExpanded);
      });
    }
  };

  // Set initial state
  const initialState = getSavedState();
  applyState(initialState, true); // Skip animation on initial load

  // Add transition class after initial state is set
  window.addEventListener('load', () => {
    tocSidebar?.classList.add('transition-transform', 'duration-200', 'ease-in-out');
  });

  // Toggle menu on button click
  menuToggle?.addEventListener('click', () => {
    const isExpanded = menuToggle.getAttribute('aria-expanded') === 'true';
    const newState = !isExpanded;
    applyState(newState);
    saveState(newState);
  });

  // Handle resize events
  let previousWidth = window.innerWidth;
  window.addEventListener('resize', () => {
    const currentWidth = window.innerWidth;
    const wasDesktop = previousWidth >= 1024;
    const nowDesktop = currentWidth >= 1024;
    
    // If we've moved from desktop to mobile/tablet
    if (wasDesktop && !nowDesktop) {
      // Always collapse on mobile/tablet
      applyState(false);
      // Clear saved state when going to mobile
      localStorage.removeItem(SIDEBAR_STATE_KEY);
    } 
    // If we've moved from mobile/tablet to desktop
    else if (!wasDesktop && nowDesktop) {
      // Restore saved state or use default
      const savedState = getSavedState();
      applyState(savedState);
    }
    
    previousWidth = currentWidth;
  });
</script>